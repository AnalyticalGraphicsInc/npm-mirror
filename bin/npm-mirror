#!/usr/bin/env node
var Package = require('../lib/package'),
    SyncManager = require('../lib/syncmanager'),
    check = require('validator').check,
    debug = require('debug')('npm-mirror'),
    fs = require('graceful-fs'),
    path = require('path'),
    program = require('commander');


/**
 * Find and parse manifest file.
 *
 * @param {string} manifestFile path to node module manifest file.
 * @return {Object} JSON-parsed module manifest.
 */
function parseManifest(manifestFile) {
  manifestFile = path.resolve(__dirname, '..', manifestFile);
  if (!fs.existsSync(manifestFile)) {
    throw new Error('Could not find manifest at ' + manifestFile);
  }

  return require(manifestFile);
}

/**
 * Make a packages directory if there isn't one already.
 *
 * @param {string} root path for mirrored packages.
 */
function resolveRoot(root) {
  var root = path.resolve(__dirname, '..', root);
  if (!fs.existsSync(root)) {
    fs.mkdirSync(root);
  }

  return root;
}

function main() {
  program
    .version('0.2.2')
    .usage([
      '--master', '<host>',
      '--manifest', '<file>',
      '--hostname', '<url>',
      '--root', '<path>'
    ].join(' '))
    .option('--master [url]', 'NPM registry to mirror packages from')
    .option('--manifest [file]', 'Node module manifest file')
    .option('--hostname [hostname]', 'Hostname for npm mirror')
    .option('--root [path]', 'Path to write downloaded packages')
    .parse(process.argv);

  if (!(program.master &&
        program.manifest &&
        program.hostname &&
        program.root)) {
    program.help();
  }

  var hostname = program.hostname;
  check(hostname).isUrl();
  var manifest = parseManifest(program.manifest);
  // We shouldn't sync the manifest's package since we want
  // the mirror to be able to sync the dependencies of private packages.
  var packageToVersions = Package.dependencies(manifest);
  var master = program.master;
  check(master).isUrl();
  var root = resolveRoot(program.root);
  var syncManager = new SyncManager(master, packageToVersions, hostname, root);
  debug('sync from ' + master);
  debug(JSON.stringify(packageToVersions));
  syncManager.sync(function(e) {
    if (e) {
      throw e;
    }

    debug('done');
  });
}

if (require.main === module) {
  main();
}
